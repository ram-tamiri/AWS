<!-- <!DOCTYPE html>
<html>
<head>
  <title>OAuth Callback</title>
</head>
<body>
  <h3>Logging in...</h3>

  <pre id="output"></pre>

  <script>
    const clientId = "6p7mk9qnnnr98do5op7kqk8lac";
    const domain = "https://ap-south-1wwt1ysqdh.auth.ap-south-1.amazoncognito.com";
    const redirectUri = "http://localhost:5500/callback.html";
    const tokenEndpoint = `https://${domain}/oauth2/token`;

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (!code) {
      document.getElementById("output").textContent = "No authorization code found.";
      throw new Error("Authorization code missing");
    }

    async function exchangeCodeForToken() {
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: clientId,
        code: code,
        redirect_uri: redirectUri
      });

      const response = await fetch(tokenEndpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: body.toString()
      });

      const data = await response.json();

      if (data.error) {
        document.getElementById("output").textContent =
          "Token error: " + JSON.stringify(data, null, 2);
        return;
      }

      const accessToken = data.access_token;

      document.getElementById("output").textContent =
        "Access Token received.\n\nCalling backend...";

      callBackend(accessToken);
    }

    async function callBackend(token) {
      const res = await fetch("http://localhost:3000/orders", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const text = await res.text();
      document.getElementById("output").textContent += "\n\nBackend response:\n" + text;
    }

    exchangeCodeForToken();
  </script>
</body>
</html> -->


<!DOCTYPE html>
<html>
<head>
  <title>OAuth Callback</title>
</head>
<body>
  <h2>Processing login...</h2>

  <pre id="output"></pre>

  <!-- <script>
    const CLIENT_ID = "7uu04549q261vdqg6ugl2ltble";
    const DOMAIN = "https://ap-south-1wwt1ysqdh.auth.ap-south-1.amazoncognito.com";
    const REDIRECT_URI = "http://localhost:5500/callback.html";

    function getAuthCode() {
      const params = new URLSearchParams(window.location.search);
      return params.get("code");
    }

    async function exchangeToken() {
      console.log("exchangeToken() started");
      const code = getAuthCode();
      const codeVerifier = sessionStorage.getItem("code_verifier");

      if (!code || !codeVerifier) {
        document.getElementById("output").innerText = "Missing code or verifier";
        return;
      }

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: CLIENT_ID,
        code: code,
        redirect_uri: REDIRECT_URI,
        code_verifier: codeVerifier
      });

      const response = await fetch(
        DOMAIN + "/oauth2/token",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: body.toString()
        }
      );

      const tokens = await response.json();
      console.log("Token response:", tokens);

      document.getElementById("output").innerText =
        JSON.stringify(tokens, null, 2);

      // Save access token for API calls
      sessionStorage.setItem("access_token", tokens.access_token);
    }

      // Call backend API using access token
      fetch("http://localhost:3000/orders", {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${tokens.access_token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("output").innerText +=
          "\n\nBackend /orders response:\n" +
          JSON.stringify(data, null, 2);
      })
      .catch(err => {
        document.getElementById("output").innerText +=
          "\n\nBackend call failed:\n" + err;
      });

    exchangeToken();
  </script>
</body>
</html> -->

<script>
  const CLIENT_ID = "7uu04549q261vdqg6ugl2ltble";
  const DOMAIN = "https://ap-south-1wwt1ysqdh.auth.ap-south-1.amazoncognito.com";
  const REDIRECT_URI = "http://localhost:5500/callback.html";

  function getAuthCode() {
    const params = new URLSearchParams(window.location.search);
    return params.get("code");
  }

  async function exchangeToken() {
    console.log("exchangeToken() started");

    const code = getAuthCode();
    const codeVerifier = sessionStorage.getItem("code_verifier");

    if (!code || !codeVerifier) {
      document.getElementById("output").innerText = "Missing code or verifier";
      return;
    }

    const body = new URLSearchParams({
      grant_type: "authorization_code",
      client_id: CLIENT_ID,
      code: code,
      redirect_uri: REDIRECT_URI,
      code_verifier: codeVerifier
    });

    const response = await fetch(DOMAIN + "/oauth2/token", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: body.toString()
    });

    const tokens = await response.json();

    console.log("Token response:", tokens);

    // document.getElementById("output").innerText =
    //   JSON.stringify(tokens, null, 2);

    // âœ… Call backend INSIDE the function
    fetch("https://cptceqas6l.execute-api.ap-south-1.amazonaws.com/Cognito-API-Integration/orders", {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${tokens.access_token}`
      }
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("output").innerText +=
        "\n\nBackend /orders response:\n" +
        JSON.stringify(data, null, 2);
    })
    .catch(err => {
      document.getElementById("output").innerText +=
        "\n\nBackend call failed:\n" + err;
    });
  }

  exchangeToken();
</script>

